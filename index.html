<html>
<head>

<link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet" />

<style>

    body {
        padding-top: 20px;
    }

    .margin-base-vertical {
        margin: 40px 0;
    }

</style>

<script src="//cdnjs.cloudflare.com/ajax/libs/coffee-script/1.7.1/coffee-script.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/batman.js/0.15.0/batman.min.js"></script>
<script type="text/coffeescript">
class GopherTV extends Batman.App
    @root 'video#index'
    @route '/video/play', 'video#play'
    @resources 'video'

class GopherTV.Video extends Batman.Model
    @persist Batman.LocalStorage
    @encode 'Id', 'YtId', 'Tags', 'Title'
    @primaryKey: 'Id'
    @resourceName: 'video'

    @FilterTag: (tag) ->
        videos = @get "all"
        return videos.filter( (v) -> (v.get("Tags").indexOf(tag) >= 0) ).toArray()

    @classAccessor 'Tags', ->
        # should cache this
        videos = @get "all"
        allTags = {}
        videos.forEach (v) ->
            v.get("Tags").forEach (t) ->
                    c = allTags[t] 
                    if c?
                        c += 1
                    else
                        c = 1
                    allTags[t] = c
        return Object.keys(allTags).sort()

class GopherTV.VideoController extends Batman.Controller

    @currentPlaylist: null
    @currentTag: null

    routingKey: 'video'
    index: ->
        @render
            into: 'taglist'
        console.log "gophertv ready!"

    playVideo: (node, event, context) ->
        vid = context.get("video")
        for v, idx in @currentPlaylist
            if v.get("YtId") is vid.get("YtId")
                ytplayer = $("#ytplayer")[0]
                ytplayer.playVideoAt(idx)

    playTag: (node, event, context) ->

        t = context.get('tag')
        console.log("playing tag", t)
        @set("currentTag", t)

        ytplayer = $("#ytplayer")[0];

        @set("currentPlaylist", GopherTV.Video.FilterTag(t) )

        ids = @currentPlaylist.map( (v) -> v.get("YtId") )
        ytplayer.cuePlaylist ids 
        ytplayer.playVideo

        @render
            into: 'playlist'
            source: 'video/playlist'

@initVideos = ->
    # hard-coded, for now
    # add: "date", slide deck link, auto-complete video title
    videos = [
        { id: "f6kdp27TYZs", tags: ["io", "concurrency", "rob-pike"], title: "Go concurrency patterns" },
        { id: "QDDwwePbDtw", tags: ["io", "concurrency", "sameer-ajmani"], title: "Advanced Go concurrency" },
        { id: "fc25ihfXhbg", tags: ["io", "appengine", "david-symonds"] , title: "High Performance Apps with Go on App Engine" },
        { id: "wyJSgTEjuII", tags: ["hangout", "appengine", "johan-euphrosine"], title: "Go + App Engine Hangout" },
        { id: "iyjqL7ZqHfg", tags: ["hangout", "google-drive"], title: "Google Drive SDK: Writing your first Drive App in Go" },
        { id: "AR9Q6UgxEuY", tags: ["ruby", "lionel-barrow"], title: "Ruby and Go" },
        { id: "elu0VpLzJL8", tags: ["python", "francesc-campoy"], title: "Go for Pythonistas" },
        { id: "p9VUCp98ay4", tags: ["io", "fireside-chat"], title: "Google I/O 2013: Fireside Chat with the Go Team" },
        { id: "sln-gJaURzk", tags: ["io", "fireside-chat"], title: "Google I/O 2012: Meet the Go Team" },
        { id: "ytEkHepK08c", tags: ["intro", "russ-cox"], title: "A Tour of Go" },
        { id: "HxaD_trXwRE", tags: ["rob-pike"], title: "Lexical Scanning in Go" },
        { id: "-i0hat7pdpk", tags: ["io", "appengine", "rob-pike", "andrew-gerrand"], title: "Writing Web Apps in Go" },
        { id: "jgVhBThJdXc", tags: ["intro", "io", "russ-cox", "rob-pike"], title: "Go Programming" },
        { id: "wCHpytRfSL4", tags: ["francesc-campoy"], title: "Singing Gophers" },
        { id: "4iAiS-qv26Q", tags: ["concurrency", "sameer-ajmani"], title: "Let's Go Further: Build Concurrent Software using the Go Programming Language" },
        { id: "2KmHtgtEZ1s", tags: ["screencast", "andrew-gerrand"], title: "Getting Started with Go" },
        { id: "7BBBl8yeIw0", tags: ["mongodb", "sam-helman"], title: "How we use Go and MongoDB at MongoDB" },
        { id: "_41bkNr7eik", tags: ["profiling", "john-graham-cumming"], title: "Profiling Go Programs" },
        { id: "XCsL89YtqCs", tags: ["screencast", "andrew-gerrand"], title: "Writing, building, installing, and testing Go code" },
        { id: "7VcArS4Wpqk", tags: ["historic", "rob-pike"], title: "Another Go at Language Design" },
        { id: "rKnDgT73v8s", tags: ["historic", "rob-pike"], title: "The Go Programming Language" },
        { id: "bj9T2c2Xk_s", tags: ["rob-pike", "andrew-gerrand"], title: "The Path to Go 1" },
        { id: "yue4X8rcGJU", tags: ["appengine", "danny-hermes", "alex-vagin"], title: "Google Cloud Endpoints on Go and PHP: An Experiment" },
    ];

    for v, i in videos
        vid = new GopherTV.Video(Id: i, YtId: v.id, Tags: v.tags, Title: v.title)
        vid.save()

@initVideos()
window.GopherTV = GopherTV
GopherTV.run()
</script>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-2  sidebar">
            <div data-yield="taglist">
            </div>
        </div>

        <div class="col-md-6 main">
            <object width="640" height="360">
                <param name="allowFullScreen" value="true"></param>
                <param name="allowScriptAccess" value="always"></param>
                <!-- video is "Getting Started with Go" -->
                <embed id="ytplayer" src="//www.youtube.com/v/2KmHtgtEZ1s?enablejsapi=1&version=3" type="application/x-shockwave-flash" allowfullscreen="true" allowScriptAccess="always" width="640" height="360"></embed>
            </object><br/>
        </div>

        <div class="col-md-4  sidebar">
            <div data-yield="playlist">
            </div>
        </div>

    </div>
</div>

<div data-defineview="video/index">
    <ul class="nav nav-sidebar">
        <li data-foreach-tag="Video.Tags">
        <a data-event-click="playTag"><span data-bind="tag"/></span></a>
        </li>
    </ul>
</div>

<div data-defineview="video/playlist">
    currently playing <span data-bind="controllers.video.currentTag"></span><br/>
    <ul class="nav nav-sidebar">
        <li data-foreach-video="controllers.video.currentPlaylist">
        <a data-event-click="playVideo"><span data-bind="video.Title"></span></a><br/>
        </li>
    </ul>
</div>

</body>
